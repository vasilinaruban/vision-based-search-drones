# Проект

Данный репозиторий содержит код бортовой системы компьютерного зрения для беспилотного воздушного судна (БВС) и вспомогательные утилиты для передачи и просмотра результатов обработки.

Система включает:

- модуль захвата видеопотока и данных GPS с борта;
- модуль инференса с использованием предварительно подготовленных моделей (ONNX / RKNN);
- модуль постобработки и визуализации результатов (изображения + JSON с объектами и координатами);
- TCP-сервер для раздачи результатов;
- настольное GUI-приложение для просмотра изображений и координат.


## Содержание

- [Описание проекта](#описание-проекта)
- [Структура репозитория](#структура-репозитория)
- [Setup](#setup)
- [Train](#train)
- [Production preparation](#production-preparation)
- [Infer](#infer)
- [Статус реализации](#статус-реализации)


## Описание проекта

### Общая архитектура

Проект реализует цепочку обработки данных с БВС:

1. Захват видеопотока с камеры и получение данных GPS по MAVLink.
2. Передача кадров в модуль нейросетевого инференса на базе RKNN / ONNX.
3. Постобработка результатов детектора, формирование изображений с отрисованными объектами и JSON-файлов с координатами.
4. Сохранение результатов на диске.
5. Передача результатов по TCP-соединению на наземную станцию.
6. Просмотр изображений и координат на настольном клиенте, с возможностью открытия координат в Яндекс.Картах.

### Модули

- `camera.py`  
  Код для работы с видеопотоком и GPS:
  - захват видеоданных (RTSP или /dev/video0);
  - подключение к MAVProxy / полётному контроллеру через `pymavlink`;
  - получение текущих координат (широта, долгота, высота).

- `rtsp_and_gps.py`  
  Скрипт захвата видеопотока и данных GPS с последующим сохранением кадров и связанной информации на диск.

- `models.py`  
  Обёртка над `rknnlite.api.RKNNLite`:
  - загрузка RKNN-моделей (например, `yolo8s__3.rknn`);
  - подготовка к инференсу на целевом устройстве (RK3588);
  - отдельный процесс для выполнения инференса.

- `orange.py`  
  Вспомогательные классы для работы с нейросетевым модулем и NPU RK3588:
  - `NeuroModule` — связка модели и очереди входных данных;
  - `RK3588` — класс, объединяющий камеру и нейросетевой модуль.

- `post_process.py`  
  Постобработка и визуализация результатов:
  - декодирование выходов нейросетевой модели;
  - фильтрация и NMS;
  - кластеризация (например, с использованием DBSCAN);
  - использование геоданных (через `geopy.distance`) для расчёта координат объектов;
  - формирование изображений с отрисованными рамками;
  - формирование JSON-файлов с описанием объектов и их координат;
  - классы `PostProcess` и `Visualizer` (экспортируются через `__init__.py`).

- `main.py`  
  Точка входа для запуска полной цепочки обработки (камера → модель → постобработка).  
  Логика интеграции модулей в текущей версии файла представлена в укороченном виде и содержит незаполненные фрагменты; полноценный сценарий запуска не реализован.

- `server.py`  
  TCP-сервер для выдачи результатов:
  - слушает заданный порт;
  - обрабатывает команды:
    - `LIST` — возвращает список файлов и их SHA256-хеши;
    - `GET <filename>` — возвращает содержимое запрошенного файла.

- `client.py`  
  Настольное GUI-приложение на Tkinter:
  - подключается к серверу по IP и порту;
  - периодически запрашивает список файлов и скачивает новые/изменённые;
  - сохраняет файлы в локальную директорию `downloads/`;
  - отображает изображения в виде галереи миниатюр;
  - при выборе изображения открывает окно просмотра;
  - ищет связанные JSON-файлы (`object_data_*.json`), извлекает координаты;
  - позволяет копировать координаты в буфер обмена и открывать их в Яндекс.Картах;
  - создаёт ZIP-архив загруженных файлов и вычисляет его SHA256.

- `concurs.service`  
  Пример unit-файла systemd для автоматического запуска скрипта на одноплатнике.

- `__init__.py`  
  Экспортирует `PostProcess` и `Visualizer` из `post_process.py` для использования как пакет.

- `lastmax.rknn`, `yolo8s__3.onnx`, `yolo8s__3.rknn`, `yolo8s__3lexa.rknn`, `orig.rknn`  
  Предварительно подготовленные файлы моделей для инференса.  


## Структура репозитория
```hz_kakoi-to format
├── configs
│   ├── data
│   ├── inference
│   ├── model
│   ├── training
├── plots
├── pyproject.toml
├── README.md
├── scripts
├── src
│   ├── data
│   ├── inference
│   ├── models
│   └── training
└── utils
    └── __init__.py

```
## Setup

### Требования

* Python 3.8+
* ОС Linux
* Библиотеки:

  * `numpy`
  * `opencv-python`
  * `onnxruntime`
  * `scikit-learn`
  * `geopy`
  * `pymavlink`
  * `pillow` (для клиента)
  * `rknnlite` / `rknn-toolkit-lite`


### Пример установки зависимостей

```bash
python -m venv venv
source venv/bin/activate  # для Windows: venv\Scripts\activate

pip install numpy opencv-python onnxruntime scikit-learn geopy pymavlink pillow
```

### Запуск TCP-сервера

```bash
python server.py
```

Сервер слушает порт и директорию, указанные в начале файла `server.py`.

### Запуск настольного клиента

```bash
python client.py
```

После запуска требуется:

1. Ввести IP-адрес и порт сервера.
2. Установить соединение.
3. Дождаться загрузки файлов в локальную папку `downloads/`.


## Train

В проекте реализован процесс обучения моделей YOLOv8 для детекции людей. Основной скрипт обучения находится в файле train_yolov8_bpla.py.

Подготовка данных:

Данные должны быть организованы в формате YOLO

Запуск обучения

```bash
python train_yolov8_bpla.py
```
## Production preparation

Код инференса на целевом устройстве реализован с использованием `rknnlite` (файлы `models.py`, `orange.py`).


## Infer

### Существующая функциональность инференса

В репозитории реализованы отдельные части инференса и обработки данных:

* Захват видеопотока и GPS:

  * файл `rtsp_and_gps.py` содержит логику:

    * подключения к источнику видеопотока (например, `/dev/video0`);
    * подключения к MAVLink (`pymavlink`);
    * периодического сохранения кадров и соответствующих координат на диск.

* Инференс на RKNN:

  * файлы `models.py` и `orange.py` описывают:

    * загрузку RKNN-модели;
    * запуск инференса в отдельном процессе;
    * работу на NPU RK3588.

* Постобработка и визуализация:

  * файл `post_process.py`:

    * обрабатывает выходы модели;
    * формирует финальные изображения с разметкой;
    * формирует JSON-файлы с информацией об объектах и координатах.


### Интеграция с TCP-сервером и клиентом

При наличии готовых изображений и JSON-файлов с результатами обработки:

* `server.py` может использоваться для раздачи этих файлов по сети.
* `client.py` используется для:

  * загрузки файлов с сервера;
  * просмотра изображений;
  * чтения JSON с данными об объектах;
  * отображения координат и открытия их в Яндекс.Картах.

Раздел Infer будет дополнен после реализации отдельного скрипта инференса и его интеграции с существующими модулями.

